name: Deploy Worker API Gateway

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      BACKEND_ORIGIN: ${{ secrets.BACKEND_ORIGIN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate required secrets
        run: |
          test -n "$CLOUDFLARE_API_TOKEN" || (echo "Missing CLOUDFLARE_API_TOKEN" && exit 1)
          test -n "$CLOUDFLARE_ACCOUNT_ID" || (echo "Missing CLOUDFLARE_ACCOUNT_ID" && exit 1)
          test -n "$BACKEND_ORIGIN" || (echo "Missing BACKEND_ORIGIN" && exit 1)

      - name: Update BACKEND_ORIGIN secret
        run: printf '%s' "$BACKEND_ORIGIN" | npx wrangler secret put BACKEND_ORIGIN --config wrangler.api-proxy.toml

      - name: Deploy Worker API gateway
        run: npx wrangler deploy --config wrangler.api-proxy.toml
